<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Acompanhar Pedidos ‚Äî FAST EPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ 
      startOnLoad: false, 
      theme: 'dark',
      securityLevel: 'loose', 
      flowchart: { htmlLabels: true, useMaxWidth: false, nodeSpacing: 100, rankSpacing: 80 }
    });
  </script>

  <style>
    :root { --bg: #0b0b0b; --card: #0f0f0f; --accent: #00e5ff; --success: #00ff88; --muted: #bfcbd0; }
    body { margin: 0; padding: 16px; background: var(--bg); color: #fff; font-family: 'Inter', Arial, sans-serif; }
    h1 { color: var(--accent); margin-bottom: 20px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
    .card { background: var(--card); border-radius: 14px; padding: 16px; border: 1px solid rgba(255,255,255,.08); }
    label { font-size: 12px; color: var(--muted); margin-bottom: 4px; display: block; }
    select, button, input { height: 48px; border-radius: 12px; border: none; padding: 0 16px; font-size: 15px; font-weight: 600; transition: 0.2s; }
    select, input { background: #fff; color: #000; }
    button { background: var(--accent); color: #000; cursor: pointer; }
    button:hover { opacity: 0.9; transform: translateY(-1px); }
    #mermaid { margin-top: 20px; overflow-x: auto; padding: 40px; background: #0f0f0f; border-radius: 14px; border: 1px solid rgba(255,255,255,.08); min-height: 300px;}
    .status-badge { background: rgba(0, 229, 255, 0.1); color: var(--accent); padding: 4px 10px; border-radius: 6px; font-size: 13px; font-weight: bold; }
    #overlayModal, #overlayPlanejamento { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9998; }
    .campo { flex: 1; display: flex; flex-direction: column; }
  </style>
</head>

<body>

<div id="overlayPlanejamento"></div>
<div id="modalPlanejamento" class="card" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:10002; width:90%; max-width:500px; border:2px solid var(--accent); box-shadow: 0 0 50px rgba(0,229,255,0.3);">
    <h2 style="color: var(--accent); margin-top:0">üèóÔ∏è Valida√ß√£o de Engenharia</h2>
    <p><strong>Obra:</strong> <span id="planoCliente"></span></p>
        <div style="background:rgba(255,255,255,0.05);
                border:1px solid #333;
                padding:12px;
                border-radius:10px;
                margin-bottom:15px;
                font-size:13px;">
        üß± <b>Produto Vendido</b><br>
        <span id="planoProduto"></span><br>
        Quantidade: <b><span id="planoQuantidade"></span></b>
    </div>

    
    <div style="background: rgba(0,229,255,0.1); border: 1px solid var(--accent); padding:10px; border-radius:8px; margin-bottom:15px; font-size:13px;">
        üë§ <b>Respons√°veis Sugeridos:</b><br>
        Corte: <span id="nomeCorte">CORTE</span> | Acabamento: <span id="nomeAcab">ACABAMENTO</span>
    </div>

    <div style="background: rgba(255,165,0,0.1); border: 1px solid orange; color: orange; padding:12px; border-radius:10px; margin-bottom:15px;">
        ‚ö†Ô∏è <b>Refer√™ncia T√©cnica:</b> Exige <b><span id="hhRef"></span> HH</b> totais.
    </div>

    <div class="row">
    <div class="campo">
        <label>N¬∫ Op. CORTE (CORTE)</label>
        <input type="number" id="qCorte" value="1" style="text-align:center;">
    </div>
    <div class="campo">
        <label>N¬∫ Op. SOLDA/MONTAGEM</label>
        <input type="number" id="qSolda" value="1" style="text-align:center;">
    </div>
</div>

<div class="row" style="margin-top: 10px;">
    <div class="campo">
        <label>N¬∫ Op. ACABAMENTO (ACABAMENTO)</label>
        <input type="number" id="qAcab" value="1" style="text-align:center;">
    </div>
    <div class="campo"></div> 
</div>

    <button style="width:100%; margin-top:20px; height:60px;" onclick="salvarAlocacaoInicial()">
        ‚úÖ APROVAR PROJETO E INICIAR PRODU√á√ÉO
    </button>
</div>

<h1>Acompanhar Pedidos</h1>

<div class="row">
  <div class="card">
    <label>Selecione o Pedido</label>
    <select id="pedidoSelect" onchange="limparVisualizacao()">
        <option value="">Carregando pedidos...</option>
    </select>
  </div>
  <div style="display: flex; align-items: flex-end;">
    <button onclick="renderizarLinha()">üîé Visualizar Detalhes</button>
  </div>
</div>

<div id="painelAcoes" class="card" style="display: none; margin-bottom: 16px; border-left: 4px solid var(--accent);">
  <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
          <span class="status-badge" id="txtStatusAtual">Status</span>
          <h3 id="txtProximoPasso" style="margin: 8px 0 0 0;">Pr√≥xima Etapa</h3>
      </div>
      <button id="btnEvoluir" onclick="executarEvolucao()">Avan√ßar Etapa ‚úÖ</button>
  </div>
</div>

<div id="mermaid">
    <p style="color: #666;">Selecione um pedido para ver a linha do tempo.</p>
</div>

<div id="overlayModal" onclick="fecharModal()"></div>
<div id="modalDetalhes" class="card" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:10000; width:95%; max-width:650px; background:#0b0b0b; border: 2px solid var(--accent); box-shadow: 0 0 100px rgba(0,229,255,0.2);">
    <div style="display:flex; justify-content:space-between; align-items:center; padding: 20px; border-bottom: 1px solid #333;">
        <h2 id="modalTituloGeral" style="margin:0; color:var(--accent); font-size:1.2rem;"></h2>
        <button onclick="fecharModal()" style="background:none; border:none; color:#fff; font-size:30px; cursor:pointer;">&times;</button>
    </div>
    
    <div id="modalCorpoDinamico" style="padding: 20px;"></div>
</div>    
</div>

<script>
let eventos = [];
let ultimoEventoSelecionado = null;
let pedidoPendenteValidacao = null;

window.fecharModal = function() {
    const overlay = document.getElementById('overlayModal');
    const modal = document.getElementById('modalDetalhes');

    if (overlay) overlay.style.display = 'none';
    if (modal) modal.style.display = 'none';
};

function herdarCampo(historico, campo) {
    for (let i = historico.length - 1; i >= 0; i--) {
        if (historico[i][campo] && historico[i][campo] !== 0) {
            return historico[i][campo];
        }
    }
    return '';
}

function carregarDados() {
    fetch('/dados/eventos.csv')
      .then(r => r.text())
      .then(csv => {
        if(!csv.trim()) return;
        const linhas = csv.trim().split('\n');
        linhas.shift();
        eventos = linhas.map(l => {
            const c = l.split(',');
            if (c.length < 10) return null;
            return {
                evento_id: c[0],
                pedido_id: c[1],
                data_evento: c[2],
                etapa: c[3],
                tipo_evento: c[4],

                // üß± PRODU√á√ÉO
                desc_placa: (c[5] || '').replace(/,/g, ' '),
                qtde_placa: parseInt(c[6]) || 0,

                descricao: (c[7] || '').replace(/,/g, ' '),
                usuario: c[8],

                custo: parseFloat(c[9]) || 0,
                receita: parseFloat(c[10]) || 0,
                status_resultante: c[11],
                data_entrega: c[12],

                cliente_nome: (c[19] || 'N√£o informado').trim(),

                hh_teorico: parseFloat(c[20]) || 0,
                corte: parseInt(c[21]) || 0,
                solda: parseInt(c[22]) || 0,
                acabamento: parseInt(c[23]) || 0,

                resp_corte: c[24],
                resp_solda: c[25],
                resp_acab: c[26],
                resp_conferencia: c[27]
            };

        }).filter(e => e !== null);
        popularPedidos();
      });
}

function popularPedidos(){
    const sel = document.getElementById('pedidoSelect');
    const ids = [...new Set(eventos.map(e => e.pedido_id))];
    sel.innerHTML = '<option value="">Escolha um pedido...</option>' + 
                    ids.reverse().map(p => `<option value="${p}">${p}</option>`).join('');
}

async function renderizarLinha() {
    const pedidoId = document.getElementById('pedidoSelect').value;
    if (!pedidoId) return;

    const evs = eventos.filter(e => e.pedido_id === pedidoId);
    if (evs.length === 0) return;
    
    ultimoEventoSelecionado = evs[evs.length - 1];

    // TRAVA: Se for pedido novo do vendedor (equipe zero), abre modal
    if (ultimoEventoSelecionado.corte === 0 && ultimoEventoSelecionado.solda === 0) {
        abrirModalGenese(ultimoEventoSelecionado);
        return;
    }

    let mer = 'flowchart LR\n';
    mer += 'classDef pill fill:#1a1a1a,stroke:#00e5ff,stroke-width:2px,color:#fff;\n';

    evs.forEach((e, i) => {
        const total = (parseInt(e.corte) || 0) + (parseInt(e.solda) || 0) + (parseInt(e.acabamento) || 0);
        const horas = total > 0 ? (e.hh_teorico / total).toFixed(1) : 0;
        const alerta = e.hh_teorico > 0 ? (horas > 8.8 ? `<br/><span style='color:#ff9800;'>‚ö†Ô∏è RISCO: ${horas}h</span>` : `<br/><span style='color:#00ff88;'>‚úÖ OK: ${horas}h</span>`) : "";
        
        const data = new Date(e.data_evento).toLocaleDateString('pt-BR');
        const label = `"${e.tipo_evento.replace(/_/g,' ')}<br/>üè¢ ${e.cliente_nome}<br/>üìÖ ${data}${alerta}"`;
        
        mer += `  E${i}(${label})\n`;
        mer += `  class E${i} pill\n`;
        mer += `  click E${i} call abrirDetalhesPedido(${i})\n`;        
        if (i > 0) mer += `  E${i-1} --> E${i}\n`;
    });

    const container = document.getElementById('mermaid');
    container.removeAttribute('data-processed');
    container.innerHTML = mer;
    await mermaid.run({ nodes: [container] });
    prepararPainelAcoes();
}

function abrirModalGenese(ev) {
    const historico = eventos.filter(e => e.pedido_id === ev.pedido_id);

    const descPlaca = herdarCampo(historico, 'desc_placa');
    const qtdePlaca = herdarCampo(historico, 'qtde_placa');

    pedidoPendenteValidacao = ev;

    document.getElementById('planoCliente').innerText = ev.cliente_nome;
    document.getElementById('hhRef').innerText = ev.hh_teorico;

    document.getElementById('planoProduto').innerText =
        descPlaca || 'Produto n√£o informado';

    document.getElementById('planoQuantidade').innerText =
        qtdePlaca || 0;

    document.getElementById('overlayPlanejamento').style.display = 'block';
    document.getElementById('modalPlanejamento').style.display = 'block';
}

async function salvarAlocacaoInicial() {
    const c = parseInt(document.getElementById('qCorte').value);
    const s = parseInt(document.getElementById('qSolda').value);
    const a = parseInt(document.getElementById('qAcab').value);

    if (!c || !s || !a || c <= 0) {
        alert("‚ö†Ô∏è Defina a equipe para continuar.");
        return;
    }

    const payload = {
        pedido_id: pedidoPendenteValidacao.pedido_id,
        tipo_evento: 'PLANEJAMENTO_CONCLUIDO',
        etapa: 'PRODUCAO',
        cliente_nome: pedidoPendenteValidacao.cliente_nome,
        hh_teorico: pedidoPendenteValidacao.hh_teorico,
        receita: pedidoPendenteValidacao.receita,
        data_entrega: pedidoPendenteValidacao.data_entrega,
        corte: c, 
        solda: s, 
        acabamento: a,
        // Novos campos baseados no seu mapeamento de fun√ß√µes
        responsavel_corte: " CORTE ", // 
        responsavel_acabamento: " ACABAMENTO ", // 
        conferencia_final: " P√ÅTIO ", // [cite: 4]
        aprovado_por: " GERENCIA " // 
    };

    const res = await fetch('/api/eventos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    if (res.ok) {
        alert("‚úÖ Plano de Produ√ß√£o Validado! O CORTE e ACABAMENTO j√° podem iniciar.");
        location.reload();
    }
}

function prepararPainelAcoes() {
    const painel = document.getElementById('painelAcoes');
    const atual = ultimoEventoSelecionado.tipo_evento;
    document.getElementById('txtStatusAtual').innerText = atual.replace(/_/g, ' ');

    let proxima = "";
    if (atual === 'PLANEJAMENTO_CONCLUIDO') proxima = 'PRODUCAO_INICIADA';
    else if (atual === 'PRODUCAO_INICIADA') proxima = 'PRODUTO_PRONTO';
    else if (atual === 'PRODUTO_PRONTO') proxima = 'SAIDA_EXPEDICAO';
    else {
        document.getElementById('txtProximoPasso').innerText = "Pedido Finalizado! üèÅ";
        document.getElementById('btnEvoluir').style.display = 'none';
        painel.style.display = 'block';
        return;
    }

    document.getElementById('txtProximoPasso').innerText = "Pr√≥ximo: " + proxima.replace(/_/g, ' ');
    document.getElementById('btnEvoluir').style.display = 'block';
    painel.style.display = 'block';
}

async function executarEvolucao() {
    const atual = ultimoEventoSelecionado.tipo_evento;
    let proxima = "";
    if (atual === 'PLANEJAMENTO_CONCLUIDO') proxima = 'PRODUCAO_INICIADA';
    else if (atual === 'PRODUCAO_INICIADA') proxima = 'PRODUTO_PRONTO';
    else if (atual === 'PRODUTO_PRONTO') proxima = 'SAIDA_EXPEDICAO';

    if (!confirm("Avan√ßar para " + proxima.replace(/_/g,' ') + "?")) return;

    const pedidoId = ultimoEventoSelecionado.pedido_id;
    const historico = eventos.filter(e => e.pedido_id === pedidoId);

    const payload = {
        pedido_id: pedidoId,
        tipo_evento: proxima,
        etapa: 'PRODUCAO',

        // üîí herdados da venda
        desc_placa: herdarCampo(historico, 'desc_placa'),
        qtde_placa: herdarCampo(historico, 'qtde_placa'),

        cliente_nome: herdarCampo(historico, 'cliente_nome'),
        hh_teorico: herdarCampo(historico, 'hh_teorico'),
        receita: herdarCampo(historico, 'receita'),
        data_entrega: herdarCampo(historico, 'data_entrega'),

        // üë• equipe permanece do √∫ltimo evento
        corte: ultimoEventoSelecionado.corte,
        solda: ultimoEventoSelecionado.solda,
        acabamento: ultimoEventoSelecionado.acabamento
    };

    await fetch('/api/eventos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    location.reload();
}

window.abrirDetalhesPedido = function(indice) {
    const pedidoId = document.getElementById('pedidoSelect').value;
    const historico = eventos.filter(e => e.pedido_id === pedidoId);
    const ev = historico[indice]; 
    if (!ev) return;

    const titulo = document.getElementById('modalTituloGeral');
    const corpo = document.getElementById('modalCorpoDinamico');
    const tipo = ev.tipo_evento.toUpperCase();

    let textoGerencial = "";
    if (tipo.includes("VENDA")) {
        textoGerencial = "Esta etapa protege sua margem de lucro ao registrar o compromisso comercial e iniciar o rastreio autom√°tico do prazo de entrega.";
    } else if (tipo.includes("PLANEJAMENTO")) {
        textoGerencial = "Aqui eliminamos o desperd√≠cio. O sistema cruza a necessidade t√©cnica com o estoque real, garantindo 'sinal verde' para a produ√ß√£o.";
    } else if (tipo.includes("PRODUCAO_INICIADA")) {
        textoGerencial = "Monitoramento de efici√™ncia em tempo real. Medimos a performance da equipe para identificar gargalos e garantir produtividade.";
    } else if (tipo.includes("PRODUTO_PRONTO")) {
        textoGerencial = "Garantia de conformidade. O produto passa por auditoria final e registro fotogr√°fico, gerando confian√ßa absoluta.";
    } else {
        textoGerencial = "Excel√™ncia na √∫ltima milha. Controle rigoroso de carga para garantir que o cliente receba exatamente o que comprou.";
    }

    let conteudoTecnico = "";
    
    if (tipo === 'VENDA_REALIZADA') {
        conteudoTecnico = `
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="card" style="background:rgba(0,229,255,0.05);"><label>RECEITA</label><h3 style="color:var(--success);">R$ ${parseFloat(ev.receita).toLocaleString('pt-BR', {minimumFractionDigits:2})}</h3></div>
                <div class="card" style="background:rgba(255,255,255,0.05);"><label>VENDEDOR</label><h4>Gilmar</h4></div>
            </div>
            <div class="card"><label>PRAZOS</label><p>Venda: ${new Date(ev.data_evento).toLocaleDateString('pt-BR')}</p></div>`;
    } 
    else if (tipo === 'PLANEJAMENTO_CONCLUIDO') {
        conteudoTecnico = `
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="card" style="background:rgba(255,255,255,0.03);"><label>APROVADOR</label><h4> Andr√© </h4></div>
                <div class="card" style="background:rgba(0,229,255,0.05);"><label>PRODU√á√ÉO</label><h4>${ev.qtde_placa} ${ev.desc_placa} Placas</h4></div>
            </div>
            <div class="card" style="margin-bottom:15px; border: 1px solid #333;">
                <label style="color:var(--accent)">üì¶ EXPLOS√ÉO DE MATERIAIS (Clique na linha Blocos EPS)</label>
                <table style="width:100%; margin-top:10px; border-collapse: collapse; font-size:13px;">
                    <tr style="color:var(--muted); text-align:left; border-bottom:1px solid #222;">
                        <th style="padding:8px;">Insumo</th><th>Nec.</th><th>Est.</th><th>Falta</th>
                    </tr>
                    <tr style="border-bottom:1px solid #111; cursor:pointer;" onclick="const d=document.getElementById('extraMat'); d.style.display=(d.style.display==='none'?'table-row':'none')">
                        <td style="padding:8px;">Blocos EPS ‚ñæ</td><td>2.0</td><td style="color:var(--success);">1.5</td><td style="color:#ff4444; font-weight:bold;">0.5</td>
                    </tr>
                    <tr id="extraMat" style="display:none; background:rgba(255,255,255,0.03);">
                        <td colspan="4" style="padding:10px; font-size:11px; color:var(--muted);">
                            üìã <b>Detalhe:</b> 40 Blocos P1 necess√°rios. 30 em estoque. Comprar 10.
                        </td>
                    </tr>
                </table>
            </div>
            <div class="card" style="border-left: 4px solid var(--success);">
                <label>üë• EQUIPE</label>
                <div style="display:flex; justify-content:space-between; font-size:13px; margin-top:5px;">
                    <span>Corte: <b> CORTE </b></span><span>Acabamento: <b>ACABAMENTO</b></span>
                </div>
            </div>`;
    } 
    else {
        conteudoTecnico = `<div class="card" style="border:1px dashed #ff9800; text-align:center; padding:20px;">
            <p style="color:#ff9800; margin:0;">‚öôÔ∏è M√ìDULO EM CONSTRU√á√ÉO</p>
            <small style="color:var(--muted);">Mapeando automa√ß√£o para ${ev.tipo_evento}</small>
        </div>`;
    }

    // 3. RENDERIZA√á√ÉO FINAL
    titulo.innerText = ev.tipo_evento.replace(/_/g, ' ');
    corpo.innerHTML = `
        <div id="camadaGerencial" style="padding:10px;">
            <div style="background:rgba(0,229,255,0.1); padding:20px; border-radius:12px; border-left:5px solid var(--accent); margin-bottom:20px;">
                <h4 style="color:var(--accent); margin-top:0;">üíé VIS√ÉO ESTRAT√âGICA</h4>
                <p style="color:#fff; font-size:14px; line-height:1.6;">${textoGerencial}</p>
            </div>
            <button onclick="window.irParaTecnico()" style="width:100%; padding:15px; background:var(--accent); color:#000; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:13px; box-shadow: 0 4px 15px rgba(0,229,255,0.3);">
                üöÄ ACESSAR DETALHES T√âCNICOS
            </button>
        </div>

        <div id="camadaTecnica" style="display:none; padding:10px;">
            ${conteudoTecnico}
            <button onclick="window.voltarParaGerencial()" style="width:100%; margin-top:15px; padding:8px; background:transparent; border:1px solid #444; color:var(--muted); cursor:pointer; font-size:11px; border-radius:5px;">
                ‚¨ÖÔ∏è VOLTAR PARA VIS√ÉO GERENCIAL
            </button>
        </div>
    `;

    document.getElementById('overlayModal').style.display = 'block';
    document.getElementById('modalDetalhes').style.display = 'block';
};

window.irParaTecnico = function() {
    document.getElementById('camadaGerencial').style.display = 'none';
    document.getElementById('camadaTecnica').style.display = 'block';
};

window.voltarParaGerencial = function() {
    document.getElementById('camadaGerencial').style.display = 'block';
    document.getElementById('camadaTecnica').style.display = 'none';
};

window.irParaTecnico = function() {
    document.getElementById('camadaGerencial').style.display = 'none';
    document.getElementById('camadaTecnica').style.display = 'block';
};

window.voltarParaGerencial = function() {
    document.getElementById('camadaGerencial').style.display = 'block';
    document.getElementById('camadaTecnica').style.display = 'none';
};

function limparVisualizacao() {
    document.getElementById('painelAcoes').style.display = 'none';
    document.getElementById('mermaid').innerHTML = '';
}

carregarDados();
</script>

</body>
</html>