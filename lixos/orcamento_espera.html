<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Or√ßamento ‚Äî FAST EPS</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#0b0b0b;
  --card:#0f0f0f;
  --accent:#00e5ff;
  --muted:#bfcbd0;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,Arial;
  background:var(--bg);
  color:#fff;
  padding:14px;
}
.wrap{
  max-width:1100px;
  margin:auto;
  display:grid;
  grid-template-columns:1.3fr 1fr;
  gap:14px;
}
h1{
  grid-column:1/-1;
  color:var(--accent);
  margin:0 0 8px 0;
}
.card{
  background:var(--card);
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.05);
}
label{font-size:12px;color:var(--muted)}

.row{display:flex;gap:8px}
.row>*{flex:1}
.card label {
  margin-top: 10px;
  display: block;
}

hr {
  margin: 18px 0;
}

button.btn {

  height: 52px; 
  font-size: 16px;
  padding: 0 14px; 
  border-radius: 14px; 
}

.btn{
  background:var(--accent);
  color:#000;
  font-weight:700;
  border:none;
  cursor:pointer;
}
.btn-danger{
  background:#ff3d3d;
  color:#fff;
}
.summary{
  background:#071214;
  padding:12px;
  border-radius:10px;
  font-size:14px;
}
.muted{color:var(--muted)}
.hidden{display:none}
hr{border:none;border-top:1px solid rgba(255,255,255,.1);margin:10px 0}
ul{padding-left:18px;margin:6px 0}

/* =========================
RESUMO OPERACIONAL
========================= */
.resumo-card{
  display:flex;
  flex-direction:column;
}

.resumo-header{
  font-weight:700;
  margin-bottom:8px;
  padding-bottom:8px;
  border-bottom:1px solid rgba(255,255,255,.12);
}

/* =========================
  RESPONSIVO ‚Äì CELULAR
========================= */
@media (max-width: 900px){
  .wrap{
    grid-template-columns:1fr;
  }

.resumo-card{
  margin-top:10px;
}
}

@media(max-width:600px){
  .row{
    flex-direction:column;
  }
}

.col-maior{
  flex:2;
}

.col-menor{
  flex:1;
}

.campo{
  display:flex;
  flex-direction:column;
  gap:4px; 
}

/* ESTILO PADR√ÉO PARA TODOS OS INPUTS/SELECTS */
.campo input,
.campo select,
.campo .campo-fixo{
  height:52px; 
  padding:12px 14px;
  font-size:16px;
  font-weight:600;

  background:#ffffff;
  color:#000;

  border-radius:14px;
  border:2px solid #d0d7de;

  transition:.2s;
}

.campo input:focus,
.campo select:focus{
  border-color:#00e5ff;
  box-shadow:0 0 0 3px rgba(0,229,255,.25);
  outline:none;
}

.campo-cliente input{
  font-size:20px;
  font-weight:700;

  border-color:#00e5ff;
  box-shadow:0 0 16px rgba(0,229,255,.35);
}

.campo-fixo{
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
}
/* ESTILO DO MODAL DE G√äNESE */
#modalPlanejamento {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 90%; max-width: 500px; z-index: 1000;
    box-shadow: 0 0 30px rgba(0,229,255,0.4); border: 2px solid var(--accent);
}
.overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 999; display: none;
}
.input-mini {
    width: 70px; height: 35px !important; text-align: center;
}

</style>
</head>

<body>

<div class="wrap">
<h1>Or√ßamento ‚Äî FAST EPS</h1>

<div class="card">
<div class="row">
  <div class="campo campo-cliente"> <label>Cliente</label>
    <input id="cliente" type="text" placeholder="Nome do cliente">
  </div>
</div>

 
<div class="row" style="margin-top:6px"> <div class="col-maior">
  <div class="campo"> <label>Tipo de Placa</label>
    <select id="tipoPlaca">
      <option value="">Selecione</option>
    </select>
    </div>
  </div>

  <div class="col-menor">
    <div class="campo"> <label>Quantidade</label>
      <input id="quantidade" type="number" value="1" maxlength="6"> </div>
  </div>

</div>

    <div class="row" style="margin-top:6px">
      <div class="campo"> <label>√Årea total (m¬≤)</label>
        <input id="area" type="number" maxlength="6">
      </div>
      <div class="campo"> <label>Espessura</label>
        <select disabled>
          <option>10 cm (P10)</option>
        </select>
      </div>
    </div>

    <div class="muted" style="margin-top:6px">
      Cada placa cobre <b>2,00 m¬≤</b>
    </div>

    <div class="row" style="margin-top:10px">

  <div class="campo"> <label>Desconto m√°ximo permitido</label>
    <div class="campo-fixo">
    <span id="descontoMaxTexto">10%</span>
  </div>
  </div>

<div class="campo">
  <label>Forma de pagamento</label>
  <select> <option>√Ä vista</option>
    <option>PIX</option>
    <option>Boleto</option>
    <option>Cart√£o</option>
    <option>Parcelado</option>
  </select>
</div>

</div>

<input id="descontoMax" type="hidden" value="10">

<div class="campo" style="margin-top:6px"> <button class="btn" style="width:100%" onclick="simular()">
    Simular capacidade
  </button>
</div>
    <hr>

<div class="campo"> <label>Desconto aplicado (%)</label>
    <input id="descontoAplicado" type="number" value="0" oninput="recalcularDesconto()" maxlength="6">
</div>

<div class="campo"> <label>Pre√ßo final negociado (R$)</label>
    <input id="precoFinal" type="text" oninput="recalcularPrecoFinal()" maxlength="9"> </div>

<div class="campo"> <label>Data de Entrega</label>
    <input id="dataEntrega" type="date">
</div>

    <div class="row" style="margin-top:10px">
    
      <div class="campo" style="flex: 1;"> <button class="btn btn-danger hidden" id="btnConfirmar" onclick="confirmarVenda()">
                ‚úÖ Confirmar Venda
            </button>
      </div>

    </div>

    <div class="card">
    <strong>Resumo Operacional</strong>
    <div id="resumo" class="summary" style="margin-top:6px">‚Äî</div>
    </div>

    </div>

<script>

/* ================= DADOS BASE ================= */
let AREA_POR_PLACA = 0;

const receitas = {};
const precoInsumos = {};
const estoque = {};
const tipoPlaca = document.getElementById('tipoPlaca');
const equipe = {};

let custoOperacionalPorPlaca = 0;
let custosFixosMensais = 0;
let producaoMensalEstimada = 0;
let margemPadrao = 0;
let custoFixoPorPlaca = 0;
let dadosCarregados = false;

Promise.all([
  fetch('/dados/receitas.csv').then(r => r.text()),
  fetch('/dados/insumos.csv').then(r => r.text()),
  fetch('/dados/estoque.csv').then(r => r.text()),
  fetch('/dados/parametros.csv').then(r => r.text()),
  fetch('/dados/constantes.csv').then(r => r.text()),
  fetch('/dados/equipe.csv').then(r => r.text())
])
.then(([csvReceitas, csvInsumos, csvEstoque, csvParametros, csvConstantes]) => {

  carregarReceitas(csvReceitas);
  carregarInsumos(csvInsumos);
  carregarEstoque(csvEstoque);
  carregarParametros(csvParametros);
  carregarConstantes(csvConstantes);
  carregarEquipe(csvEquipe);

  dadosCarregados = true;
})
.catch(err => {
  console.error(err);
  alert('Erro ao carregar dados');
});

/* ================= FUN√á√ÉO PARA CARREGAR EQUIPE ================= */
function carregarEquipe(csv) {
  const linhas = csv.trim().split('\n');
  linhas.shift(); // Remove o cabe√ßalho

  linhas.forEach(l => {
    const [id, nome, funcao, etapas] = l.split(',');
    equipe[id] = { 
      nome: nome.trim(), 
      funcao: funcao.trim(),
      etapas: etapas.trim()
    };
  });
  console.log("Equipe Fast EPS carregada:", equipe);
}
/* ================= HIST√ìRICO INTERNO ================= */
const historicoVendas = [];

let contextoAtual = null;

/* ================= FORMATA√á√ÉO MONET√ÅRIA ================= */
function formatBR(valor){
  return valor.toLocaleString('pt-BR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

function parseBR(valor){
  if(!valor) return 0;
  return Number(valor.replace(/\./g,'').replace(',','.'));
}

function aplicarMascaraMonetaria(el){
  el.addEventListener('input', () => {
    let v = el.value.replace(/\D/g,'');
    v = (Number(v) / 100).toFixed(2);
    el.value = formatBR(Number(v));
  });
}

/* ================= FUN√á√ïES DE C√ÅLCULO ================= */
function carregarReceitas(csv){
  const linhas = csv.trim().split('\n');
  linhas.shift();

  linhas.forEach(l => {
    const c = l.split(',');

    receitas[c[0]] = {
      nome: c[1],
      fator: Number(c[2]),
      itens:{
        eps:Number(c[3]),
        tela:Number(c[4]),
        cimento:Number(c[5]),
        areia:Number(c[6]),
        aditivo:Number(c[7]),
        conectores:Number(c[8])
      }
    };

    tipoPlaca.innerHTML += `<option value="${c[0]}">${c[1]}</option>`;
  });
}
function carregarInsumos(csv){
  const linhas = csv.trim().split('\n');
  linhas.shift();

  linhas.forEach(l => {
    const [insumo, valor] = l.split(',');
    precoInsumos[insumo] = Number(valor);
  });
}

function carregarEstoque(csv){
  const linhas = csv.trim().split('\n');
  linhas.shift();

  linhas.forEach(l => {
    const [insumo, qtd] = l.split(',');
    estoque[insumo] = Number(qtd);
  });
}

function carregarParametros(csv){
  const linhas = csv.trim().split('\n');
  linhas.shift();

  linhas.forEach(l => {
    const [chave, valor] = l.split(',');
    if(chave === 'custoOperacionalPorPlaca') custoOperacionalPorPlaca = Number(valor);
    if(chave === 'custosFixosMensais') custosFixosMensais = Number(valor);
    if(chave === 'producaoMensalEstimada') producaoMensalEstimada = Number(valor);
    if(chave === 'margemPadrao') margemPadrao = Number(valor);
  });

  custoFixoPorPlaca = custosFixosMensais / producaoMensalEstimada;
}

function carregarConstantes(csv){
  const linhas = csv.trim().split('\n');
  linhas.shift();

  linhas.forEach(l => {
    const [chave, valor] = l.split(',');
    if(chave === 'AREA_POR_PLACA') AREA_POR_PLACA = Number(valor);
  });
}


function consumoTotal(produto, qtd){
  const r = receitas[produto];
  const total = {};
  for(const k in r.itens){
    total[k] = r.itens[k] * qtd * (1 + r.fator);
  }
  return total;
}

function detalharCustoInsumos(produto, qtd){
  const r = receitas[produto];
  const detalhes = {};
  let totalCustoDireto = 0;

  for(const k in r.itens){
    const custoUnitario = precoInsumos[k] || 0;
    const consumoPorPlaca = r.itens[k] * (1 + r.fator);
    const custoPorPlaca = consumoPorPlaca * custoUnitario;
    totalCustoDireto += custoPorPlaca;
    
    detalhes[k] = custoPorPlaca;
  }

  return { detalhes, totalCustoDireto };
}

function custoTotalPorPlaca(produto){
  const { totalCustoDireto } = detalharCustoInsumos(produto, 1);
  return (
    totalCustoDireto + 
    custoOperacionalPorPlaca +
    custoFixoPorPlaca
  );
}

function precificacao(produto, margem = margemPadrao){
  const { totalCustoDireto, detalhes } = detalharCustoInsumos(produto, 1); // Calcula o detalhe para 1 placa
  const custoPlaca = totalCustoDireto + custoOperacionalPorPlaca + custoFixoPorPlaca;
  const precoPlaca = custoPlaca * (1 + margem);

  return {
    custoDiretoPlaca: totalCustoDireto, 
    custoPlaca,
    precoPlaca,
    lucroPlaca: precoPlaca - custoPlaca,
    detalhesInsumos: detalhes 
  };
}

function capacidade(produto){
  const r = receitas[produto];
  if (!r) {
    console.error('Produto n√£o encontrado em receitas:', produto, receitas);
    return { max: 0, gargalo: '‚Äî' };
  }

  let max = Infinity, gargalo = '';
  for(const k in r.itens){
    const porPlaca = r.itens[k] * (1 + r.fator);
    const placas = Math.floor((estoque[k]||0) / porPlaca);
    if(placas < max){ max = placas; gargalo = k; }
  }
  return { max, gargalo };
}

function comprasNecessarias(produto, qtd){
  const consumo = consumoTotal(produto, qtd);
  const lista = {};
  for(const k in consumo){
    const falta = consumo[k] - (estoque[k]||0);
    if(falta > 0) lista[k] = falta;
  }
  return lista;
}


function calcularPrecoMinimo(precoSugerido, descontoMax){
  return precoSugerido * (1 - descontoMax / 100);
}

function recalcularDesconto(){
  if(!contextoAtual) return;

  const descontoMax = Number(descontoMaxEl.value);
  const desconto = Number(descontoAplicadoEl.value);
  const precoSugerido = contextoAtual.precificacao.precoSugeridoTotal;

  if(desconto > descontoMax){
    alert("‚ö†Ô∏è Desconto acima do permitido!");
    descontoAplicadoEl.value = descontoMax;
    return recalcularDesconto();
  }

  const precoFinal = precoSugerido * (1 - desconto / 100);
  precoFinalEl.value = formatBR(precoFinal);

  atualizarResumoDesconto(precoFinal, desconto);
}

function recalcularPrecoFinal(){
  if(!contextoAtual) return;

  const precoSugerido = contextoAtual.precificacao.precoSugeridoTotal;
  const precoFinal = parseBR(precoFinalEl.value); 

  const descontoMax = Number(descontoMaxEl.value || 0);
  const precoMinimo = calcularPrecoMinimo(precoSugerido, descontoMax);

  const desconto = ((precoSugerido - precoFinal) / precoSugerido) * 100;

  if(precoFinal < precoMinimo){
    alert("‚ö†Ô∏è Pre√ßo abaixo do m√≠nimo permitido!");
    precoFinalEl.value = formatBR(precoMinimo);
    return recalcularPrecoFinal();
  }

  descontoAplicadoEl.value = desconto.toFixed(2);
  atualizarResumoDesconto(precoFinal, desconto);
}

function atualizarResumoDesconto(precoFinal, desconto){
  const custo = contextoAtual.precificacao.custoTotal;
  const lucroFinal = precoFinal - custo;

  contextoAtual.negociacao = {
    descontoAplicado: desconto,
    precoFinal,
    lucroFinal
  };
}

/* ================= PRINCIPAIS ================= */

function simular(){
  if(!dadosCarregados){
    alert('‚è≥ Aguarde, carregando dados...');
    return;  
  }
  const cliente = clienteEl.value || '‚Äî';
  const produto = produtoEl.value;
  const qtd = Number(qtdEl.value);
  const area = Number(areaEl.value);

  if (!receitas[produto]) {
    alert("Tipo de placa inv√°lido ou n√£o carregado.");
    return;
  }
  
  if(!produto || produto === 'Selecione' || !qtd || qtd <= 0) {
    alert("Preencha Tipo de Placa e Quantidade.");
    return;
  }

  const cap = capacidade(produto);
  const compras = comprasNecessarias(produto, qtd);

  const prec = precificacao(produto);
  const custoTotal = prec.custoPlaca * qtd;
  const precoSugeridoTotal = prec.precoPlaca * qtd;
  const lucroTotal = precoSugeridoTotal - custoTotal;
  const descontoMax = 10;
  descontoMaxEl.value = descontoMax;
  const precoMinimo = calcularPrecoMinimo(precoSugeridoTotal, descontoMax);

  let html = `
  <div><b>Cliente:</b> ${cliente}</div>
  <div><b>Produto:</b> ${receitas[produto].nome}</div>
  <div><b>√Årea:</b> ${area || '‚Äî'} m¬≤</div>
  <div><b>Placas:</b> ${qtd}</div>
  <hr>
  <div><b>Capacidade produtiva:</b> ${cap.max} placas</div>
  <div><b>Status:</b> ${cap.max >= qtd ? 'üü¢ OK' : 'üî¥ Estoque insuficiente'}</div>
  <div class="muted">Insumo limitante: ${cap.gargalo}</div>
  `;

html += `
<hr>
<b>üí∞ Precifica√ß√£o</b>
<div>Custo por placa: R$ ${formatBR(prec.custoPlaca)}</div>
<div>Pre√ßo sugerido por placa: R$ ${formatBR(prec.precoPlaca)}</div>
<div>Lucro por placa: R$ ${formatBR(prec.lucroPlaca)}</div>

<hr>

<div><b>Custo total:</b> R$ ${formatBR(custoTotal)}</div>
<div><b>Pre√ßo sugerido total:</b> R$ ${formatBR(precoSugeridoTotal)}</div>
<div><b>Lucro estimado:</b> R$ ${formatBR(lucroTotal)}</div>

<hr>
<b>üìâ Pol√≠tica de Desconto</b>
<div>Pre√ßo sugerido: R$ ${formatBR(precoSugeridoTotal)}</div>
<div>Desconto m√°ximo: ${descontoMax}%</div>
<div>Pre√ßo m√≠nimo permitido: R$ ${formatBR(precoMinimo)}</div>
`;

  if(Object.keys(compras).length){
    html += `<hr><b>üì¶ Necessidade de Compra</b><ul>`;
    for(const k in compras){
      html += `<li>${k}: ${compras[k].toFixed(2)}</li>`;
    }
    html += `</ul>`;
  }

  resumo.innerHTML = html;
  contextoAtual = {
    cliente,
    produto,
    qtd,
    area,
    compras,
    precificacao: {
           custoDiretoPlaca: prec.custoDiretoPlaca,
           custoPlaca: prec.custoPlaca,
           precoPlaca: prec.precoPlaca,
           lucroPlaca: prec.lucroPlaca,
           custoTotal,
           precoSugeridoTotal,
           lucroTotal,
           detalhesInsumos: prec.detalhesInsumos 
         },
    negociacao: {
      descontoAplicado: 0,
      precoFinal: precoSugeridoTotal,
      lucroFinal: lucroTotal
    }
  };

  btnConfirmar.classList.remove('hidden');
  descontoAplicadoEl.value = 0;
  precoFinalEl.value = formatBR(precoSugeridoTotal);
}

async function confirmarVenda() {
  if (btnConfirmar.disabled) return;
  btnConfirmar.disabled = true;

  const preco = parseBR(precoFinalEl.value);
  const dataEntrega = dataEntregaEl.value;
  const custoReal = contextoAtual.precificacao.custoTotal;
  const lucroReal = preco - custoReal;

  if (preco <= 0 || !dataEntrega) {
    btnConfirmar.disabled = false;
    return alert("Informe pre√ßo e data de entrega");
  }

  if (lucroReal < 0) {
    if (!confirm("‚ö†Ô∏è Venda com preju√≠zo. Deseja continuar?")) {
      btnConfirmar.disabled = false;
      return;
    }
  }

  const pedidoId = `PED-${Date.now()}`;

  // Criamos o objeto que vai para o CSV do Portal üíé
  const novoEvento = {
    pedido_id: pedidoId,
    tipo_evento: 'VENDA_REALIZADA',
    etapa: 'VENDA',
    cliente_nome: contextoAtual.cliente,
    hh_teorico: contextoAtual.capacidade.hhTotal,
    receita: preco,
    data_entrega: dataEntrega,
    // AQUI EST√Å O SEGREDO: Enviamos 0 para travar no Acompanhamento
    corte: 0,
    solda: 0,
    acabamento: 0,
    data_evento: new Date().toISOString()
  };

  try {
    // 1. Gera o PDF para o cliente
    gerarPDF({...contextoAtual, preco, dataEntrega});

    // 2. SALVA NO SERVIDOR (Substitui o abrirGenese)
    const response = await fetch('/api/eventos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(novoEvento)
    });

    if (response.ok) {
      alert("‚úÖ Venda Registrada! Agora v√° em 'Acompanhar Pedidos' para validar a produ√ß√£o.");
      window.location.href = "acompanhar_pedido.html";
    } else {
      throw new Error("Falha ao salvar no servidor");
    }

  } catch (err) {
    console.error(err);
    alert("‚ùå Erro ao salvar pedido.");
    btnConfirmar.disabled = false;
  }
}

async function registrarEvento(evento){
  const res = await fetch('/api/evento', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(evento)
  });

  const json = await res.json();
  if(!json.sucesso){
    throw new Error('Falha ao registrar evento');
  }
}

  // ===============================
  // FINALIZA VENDA
  // ===============================

function resetarFormulario(){
  clienteEl.value = '';
  produtoEl.value = '';
  qtdEl.value = 1;
  areaEl.value = '';
  descontoAplicadoEl.value = 0;
  precoFinalEl.value = '';
  dataEntregaEl.value = '';

  resumo.innerHTML = '‚Äî';
  btnConfirmar.classList.add('hidden');

  contextoAtual = null;
}


function gerarPDF(v){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const ACCENT_COLOR = '#00e5ff'; 
  const TEXT_COLOR = '#000000'; 
  const DETAIL_COLOR = '#444444'; 
  let y = 15; 

  // ====================================
  // 1. CABE√áALHO
  // ====================================
  doc.setFontSize(18);
  doc.setTextColor(ACCENT_COLOR);
  doc.setFont('helvetica', 'bold');
  doc.text("OR√áAMENTO ‚Äî FAST EPS", 14, y);
  y += 8;

  doc.setFontSize(9);
  doc.setTextColor(DETAIL_COLOR);
  doc.setFont('helvetica', 'normal');
  doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 14, y);
  y += 5;
  doc.setDrawColor(ACCENT_COLOR);
  doc.line(14, y, 196, y); 
  y += 7;

  // ====================================
  // 2. DETALHES DO PROJETO
  // ====================================
  doc.setFontSize(11);
  doc.setTextColor(TEXT_COLOR);
  doc.setFont('helvetica', 'bold');
  doc.text("DADOS DO PROJETO", 14, y);
  y += 7;

  doc.setFont('helvetica', 'normal');
  doc.text(`Cliente: ${v.cliente}`, 18, y);
  y += 6;
  doc.text(`Produto: ${receitas[v.produto].nome}`, 18, y);
    doc.text(`Quantidade: ${v.qtd} placas`, 90, y);
  y += 6;
  doc.text(`√Årea Total: ${v.area || '‚Äî'} m¬≤`, 18, y);
  doc.text(`Data de Entrega: ${v.dataEntrega}`, 90, y);
  y += 10;
  
  // ====================================
  // 3. DETALHAMENTO DE CUSTOS (POR PLACA)
  // ====================================
  doc.setFont('helvetica', 'bold');
  doc.text("DETALHAMENTO DO CUSTO POR PLACA", 14, y);
  y += 7;
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  
  // 3.1 CUSTOS DIRETOS (INSUMOS)
  doc.setTextColor(DETAIL_COLOR);
  doc.text(`CUSTOS DIRETOS (INSUMOS):`, 18, y);
  doc.text(`R$ ${formatBR(v.precificacao.custoDiretoPlaca)}`, 180, y, { align: 'right' }); 
  y += 5;
  
  for(const insumo in v.precificacao.detalhesInsumos){
      const valor = v.precificacao.detalhesInsumos[insumo];
      doc.text(`- ${insumo.charAt(0).toUpperCase() + insumo.slice(1)}`, 22, y);
      doc.text(`R$ ${formatBR(valor)}`, 180, y, { align: 'right' });
      y += 5;
  }
  y += 2;

  // 3.2 OUTROS CUSTOS
  doc.text(`CUSTOS OPERACIONAIS (Ex: M√£o de Obra Vari√°vel):`, 18, y);
  doc.text(`R$ ${formatBR(custoOperacionalPorPlaca)}`, 180, y, { align: 'right' });
  y += 5;
  doc.text(`CUSTOS FIXOS RATEADOS (Ex: Aluguel, Sal√°rios Fixos):`, 18, y);
  doc.text(`R$ ${formatBR(custoFixoPorPlaca)}`, 180, y, { align: 'right' });
  y += 5;

  y += 3;
  doc.setFontSize(12);
  doc.setTextColor(ACCENT_COLOR);
  doc.setFont('helvetica', 'bold');
  doc.text(`CUSTO TOTAL DA PLACA:`, 18, y);
  doc.text(`R$ ${formatBR(v.precificacao.custoPlaca)}`, 180, y, { align: 'right' });
  y += 12;
  
  // ====================================
  // 4. PRECIFICA√á√ÉO E NEGOCIA√á√ÉO
  // ====================================
  doc.setTextColor(TEXT_COLOR);
  doc.setFontSize(11);
  doc.text("POL√çTICA DE PRE√áO E NEGOCIA√á√ÉO", 14, y);
  y += 7;

  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');

  doc.text(`Pre√ßo Sugerido Total:`, 18, y);
  doc.text(`R$ ${formatBR(v.precificacao.precoSugeridoTotal)}`, 180, y, { align: 'right' });
  y += 5;
  
  doc.text(`Desconto Aplicado/Acr√©scimo :`, 18, y);
  doc.text(`${formatBR(v.negociacao.descontoAplicado)}%`, 180, y, { align: 'right' }); 
  y += 5;

  y += 3;
  doc.setFontSize(12);
  doc.setTextColor(ACCENT_COLOR);
  doc.setFont('helvetica', 'bold');
  doc.text(`PRE√áO FINAL NEGOCIADO:`, 18, y);
  doc.text(`R$ ${formatBR(v.negociacao.precoFinal)}`, 180, y, { align: 'right' });
  y += 10; 

  // ====================================
  // 5. NECESSIDADE DE COMPRAS
  // ====================================
  let custoTotalReposicao = 0;
  if(Object.keys(v.compras).length){
      doc.setDrawColor(200);
      doc.line(14, y, 196, y); // Linha separadora
      y += 7;

      doc.setFont('helvetica', 'bold');
      doc.setTextColor(TEXT_COLOR);
      doc.setFontSize(11);
      doc.text("NECESSIDADE DE COMPRAS (FALTA COMPRAR PARA EXECUTAR A ORDEM DE VENDA)", 14, y);
      y += 7;

      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');

      doc.text("INSUMO", 18, y);
      doc.text("FALTA", 80, y);
      doc.text("PRE√áO UN.", 120, y);
      doc.text("CUSTO REPOSI√á√ÉO (R$)", 180, y, { align: 'right' });
      y += 3;
      
      doc.setDrawColor(DETAIL_COLOR);
      doc.line(14, y, 196, y); 
      y += 5;

      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      
      for(const k in v.compras){
          const falta = v.compras[k];
          const precoUnitario = precoInsumos[k] || 0;
          const custoItem = falta * precoUnitario;
          custoTotalReposicao += custoItem;
          
          doc.text(k.charAt(0).toUpperCase() + k.slice(1), 18, y);
          doc.text(falta.toFixed(2), 80, y);
          doc.text(`R$ ${formatBR(precoUnitario)}`, 120, y);
          doc.text(formatBR(custoItem), 180, y, { align: 'right' });
          y += 5;
      }

      // Total da Reposi√ß√£o (Destaque)
      y += 3;
      doc.setDrawColor(DETAIL_COLOR);
      doc.line(14, y, 196, y); 
      y += 4;
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.setTextColor(ACCENT_COLOR);
      doc.text("INVESTIMENTO TOTAL DE REPOSI√á√ÉO:", 18, y);
      doc.text(`R$ ${formatBR(custoTotalReposicao)}`, 180, y, { align: 'right' });
      y += 10;
  }

  // ====================================
  // 6. RESUMO FINANCEIRO EXECUTIVO
  // ====================================
  
  const custoDiretoTotalVenda = v.precificacao.custoDiretoPlaca * v.qtd;
  const custoAdicionalTotal = (custoOperacionalPorPlaca + custoFixoPorPlaca) * v.qtd;
  const lucroReal = v.preco - v.precificacao.custoTotal;
  
  const cap = capacidade(v.produto); 
  const placasNoEstoque = cap.max >= v.qtd ? v.qtd : cap.max; 
  const placasFaltantes = v.qtd - placasNoEstoque; 
  
  doc.setDrawColor(200);
  doc.line(14, y, 196, y); 
  y += 7;

  doc.setFont('helvetica', 'bold');
  doc.setTextColor(TEXT_COLOR);
  doc.setFontSize(11);
  doc.text("RESUMO FINANCEIRO EXECUTIVO", 14, y);
  y += 7;

  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  
  // ====================================
  // 6.1 DADOS DA VENDA
  // ====================================

  doc.setFont('helvetica', 'bold');
  doc.text(`VENDA EXECUTADA (${v.qtd} PLACAS):`, 18, y);
  doc.text(`R$ ${formatBR(v.negociacao.precoFinal)}`, 180, y, { align: 'right' }); 
  y += 5;
  doc.setFont('helvetica', 'normal'); 
  
  // CUSTO TOTAL DO OR√áAMENTO (Custo Padr√£o)
  doc.text(`CUSTO TOTAL DE REFER√äNCIA (Padr√£o Cont√°bil):`, 18, y);
  doc.text(`R$ ${formatBR(v.precificacao.custoTotal)}`, 180, y, { align: 'right' });
  y += 5;
  
  // GANHO REAL DE VENDA (Lucro) 
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(ACCENT_COLOR);
  doc.text(`GANHO REAL DE VENDA (Lucro):`, 18, y);
  doc.text(`R$ ${formatBR(lucroReal)}`, 180, y, { align: 'right' });
  y += 7;
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(TEXT_COLOR);
  
  doc.setDrawColor(DETAIL_COLOR);
  doc.line(14, y, 196, y);
  y += 5;

  // ====================================
  // 6.2 CUSTOS DE CAMPO E FLUXO DE CAIXA
  // ====================================

  doc.text(`CUSTO DE INSUMOS DA VENDA (${v.qtd} PLACAS):`, 18, y);
  doc.text(`R$ ${formatBR(custoDiretoTotalVenda)}`, 180, y, { align: 'right' });
  y += 5;

  doc.text(`OPERA√á√ÉO E CUSTOS FIXOS:`, 18, y);
  doc.text(`R$ ${formatBR(custoAdicionalTotal)}`, 180, y, { align: 'right' });
  y += 5;

 doc.setFont('helvetica', 'bold');
  const custoDaVenda = custoDiretoTotalVenda + custoAdicionalTotal;
  doc.text(`TOTAL PERSONALIZADO DE CUSTO:`, 18, y);
  doc.text(`R$ ${formatBR(custoDaVenda)}`, 180, y, { align: 'right' });
  y += 10;
  
  doc.save(`venda_${v.cliente}_${Date.now()}.pdf`);
}


/* ================= ELEMENTOS ================= */
const clienteEl = document.getElementById('cliente');
const produtoEl = document.getElementById('tipoPlaca');
const qtdEl = document.getElementById('quantidade');
const areaEl = document.getElementById('area');
const resumo = document.getElementById('resumo');
const btnConfirmar = document.getElementById('btnConfirmar');
const dataEntregaEl = document.getElementById('dataEntrega');
const descontoMaxEl = document.getElementById('descontoMax');
const descontoAplicadoEl = document.getElementById('descontoAplicado');
const precoFinalEl = document.getElementById('precoFinal');

precoFinalEl.addEventListener('blur', () => {
    // Usa parseBR para garantir que limpa a formata√ß√£o ao focar/desfocar
    const valorNumerico = parseBR(precoFinalEl.value);
    precoFinalEl.value = formatBR(valorNumerico);
});  

/* ================= M√ÅSCARAS ================= */
aplicarMascaraMonetaria(precoFinalEl);


// VARI√ÅVEL GLOBAL PARA O EVENTO
let eventoPendente = null;

function calcularCorNo(evento) {
    const hhTeorico = evento.parametros_planta.hh_teorico;
    const alocacao = evento.parametros_planta.alocacao_real;
    const totalGente = Number(alocacao.corte) + Number(alocacao.solda) + Number(alocacao.acabamento);
    
    // Tempo que levar√° para produzir com essa equipe
    const horasEstimadas = hhTeorico / totalGente;
    
    // Se levar mais de 10 horas (excedendo um turno normal), alerta amarelo
    if (horasEstimadas > 12) return "fill:#ff3d3d,stroke:#fff,stroke-width:4px,color:#fff"; // VERMELHO (Cr√≠tico)
    if (horasEstimadas > 8.8) return "fill:#ff9800,stroke:#fff,stroke-width:2px"; // LARANJA (Risco)
    
    return "fill:#00e5ff,stroke:#fff,color:#000"; // CIANO (OK)
}

</script>

</body>
</html>
